<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>The InQUIZitive MIDDler: Regulatory Chronicles</title>
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Orbitron:wght@400;700;900&family=Rajdhani:wght@300;400;600;700&display=swap');
        
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Rajdhani', sans-serif;
            line-height: 1.6;
            color: #e2e8f0;
            background: linear-gradient(135deg, #0f0f23 0%, #1a1a2e 25%, #16213e 50%, #0f3460 75%, #533483 100%);
            min-height: 100vh;
            overflow-x: hidden;
        }

        .stars {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            pointer-events: none;
            background-image: 
                radial-gradient(2px 2px at 20px 30px, #fff, transparent),
                radial-gradient(2px 2px at 40px 70px, #fff, transparent),
                radial-gradient(1px 1px at 90px 40px, #fff, transparent),
                radial-gradient(1px 1px at 130px 80px, #fff, transparent),
                radial-gradient(2px 2px at 160px 30px, #fff, transparent);
            background-repeat: repeat;
            background-size: 200px 100px;
            animation: sparkle 3s linear infinite;
            opacity: 0.6;
        }

        @keyframes sparkle {
            0% { transform: translateY(0px); }
            100% { transform: translateY(-100px); }
        }

        .container {
            max-width: 1200px;
            margin: 0 auto;
            padding: 20px;
            position: relative;
            z-index: 1;
        }

        .game-header {
            background: linear-gradient(135deg, rgba(0,0,0,0.9), rgba(30,30,60,0.9));
            padding: 30px;
            border-radius: 20px;
            text-align: center;
            margin-bottom: 25px;
            box-shadow: 0 20px 40px rgba(0,0,0,0.3);
            border: 2px solid #4fd1c7;
            position: relative;
            overflow: hidden;
        }

        .game-header::before {
            content: '';
            position: absolute;
            top: 0;
            left: -100%;
            width: 100%;
            height: 100%;
            background: linear-gradient(90deg, transparent, rgba(79, 209, 199, 0.1), transparent);
            animation: scan 3s ease-in-out infinite;
        }

        @keyframes scan {
            0% { left: -100%; }
            50% { left: 100%; }
            100% { left: 100%; }
        }

        .game-title {
            font-family: 'Orbitron', monospace;
            font-size: 3em;
            font-weight: 900;
            background: linear-gradient(45deg, #4fd1c7, #06b6d4, #8b5cf6);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            margin-bottom: 10px;
            text-shadow: 0 0 30px rgba(79, 209, 199, 0.3);
            position: relative;
        }

        .game-subtitle {
            font-size: 1.3em;
            color: #94a3b8;
            font-weight: 400;
            letter-spacing: 1px;
        }

        .player-stats {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 20px;
            margin-bottom: 25px;
        }

        .stat-card {
            background: linear-gradient(135deg, rgba(0,0,0,0.6), rgba(30,30,60,0.6));
            padding: 20px;
            border-radius: 15px;
            border: 1px solid #374151;
            text-align: center;
            position: relative;
            overflow: hidden;
        }

        .stat-card::before {
            content: '';
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 2px;
            background: linear-gradient(90deg, #4fd1c7, #06b6d4);
        }

        .stat-label {
            color: #9ca3af;
            font-size: 0.9em;
            font-weight: 600;
            text-transform: uppercase;
            letter-spacing: 1px;
            margin-bottom: 8px;
        }

        .stat-value {
            font-family: 'Orbitron', monospace;
            font-size: 1.5em;
            font-weight: 700;
            color: #4fd1c7;
        }

        .stat-bar {
            width: 100%;
            height: 6px;
            background: #374151;
            border-radius: 3px;
            margin-top: 10px;
            overflow: hidden;
        }

        .stat-fill {
            height: 100%;
            background: linear-gradient(90deg, #ef4444, #f59e0b, #10b981);
            border-radius: 3px;
            transition: width 0.5s ease;
        }

        .mission-setup {
            background: linear-gradient(135deg, rgba(0,0,0,0.8), rgba(30,30,60,0.8));
            padding: 40px;
            border-radius: 20px;
            margin-bottom: 25px;
            border: 1px solid #4338ca;
            box-shadow: 0 15px 35px rgba(0,0,0,0.2);
        }

        .mission-title {
            font-family: 'Orbitron', monospace;
            font-size: 1.8em;
            color: #8b5cf6;
            margin-bottom: 20px;
            text-align: center;
        }

        .difficulty-selection {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(280px, 1fr));
            gap: 20px;
            margin-bottom: 30px;
        }

        .difficulty-card {
            background: linear-gradient(135deg, rgba(0,0,0,0.7), rgba(50,50,80,0.7));
            padding: 25px;
            border-radius: 15px;
            border: 2px solid transparent;
            cursor: pointer;
            transition: all 0.3s ease;
            position: relative;
            overflow: hidden;
        }

        .difficulty-card:hover {
            border-color: #4fd1c7;
            transform: translateY(-5px);
            box-shadow: 0 10px 30px rgba(79, 209, 199, 0.2);
        }

        .difficulty-card.selected {
            border-color: #4fd1c7;
            background: linear-gradient(135deg, rgba(79, 209, 199, 0.1), rgba(139, 92, 246, 0.1));
        }

        .difficulty-header {
            display: flex;
            align-items: center;
            margin-bottom: 12px;
        }

        .difficulty-icon {
            font-size: 1.5em;
            margin-right: 10px;
        }

        .difficulty-name {
            font-family: 'Orbitron', monospace;
            font-weight: 700;
            font-size: 1.2em;
        }

        .difficulty-description {
            color: #94a3b8;
            font-size: 0.95em;
            margin-bottom: 15px;
        }

        .difficulty-rewards {
            font-size: 0.85em;
            color: #fbbf24;
        }

        .mission-length {
            display: flex;
            justify-content: center;
            gap: 15px;
            margin-bottom: 30px;
        }

        .length-option {
            background: rgba(0,0,0,0.6);
            padding: 15px 25px;
            border-radius: 10px;
            border: 1px solid #374151;
            cursor: pointer;
            transition: all 0.3s ease;
            text-align: center;
        }

        .length-option:hover, .length-option.selected {
            border-color: #8b5cf6;
            background: rgba(139, 92, 246, 0.1);
        }

        .launch-mission {
            width: 100%;
            padding: 18px;
            background: linear-gradient(135deg, #8b5cf6, #6366f1);
            color: white;
            border: none;
            border-radius: 12px;
            font-family: 'Orbitron', monospace;
            font-size: 1.2em;
            font-weight: 700;
            cursor: pointer;
            transition: all 0.3s ease;
            text-transform: uppercase;
            letter-spacing: 1px;
            position: relative;
            overflow: hidden;
        }

        .launch-mission:hover {
            transform: translateY(-3px);
            box-shadow: 0 10px 30px rgba(139, 92, 246, 0.4);
        }

        .launch-mission:disabled {
            opacity: 0.5;
            cursor: not-allowed;
            transform: none;
        }

        .launch-mission::before {
            content: '';
            position: absolute;
            top: 0;
            left: -100%;
            width: 100%;
            height: 100%;
            background: linear-gradient(90deg, transparent, rgba(255,255,255,0.2), transparent);
            transition: left 0.5s;
        }

        .launch-mission:hover::before {
            left: 100%;
        }

        .game-progress {
            background: rgba(0,0,0,0.8);
            padding: 20px;
            border-radius: 15px;
            margin-bottom: 20px;
            border: 1px solid #374151;
        }

        .progress-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 15px;
        }

        .mission-info {
            font-family: 'Orbitron', monospace;
            color: #4fd1c7;
            font-weight: 600;
        }

        .progress-bar {
            width: 100%;
            height: 8px;
            background: #374151;
            border-radius: 4px;
            overflow: hidden;
        }

        .progress-fill {
            height: 100%;
            background: linear-gradient(90deg, #8b5cf6, #06b6d4, #10b981);
            border-radius: 4px;
            transition: width 0.5s ease;
        }

        .scenario-container {
            background: linear-gradient(135deg, rgba(0,0,0,0.9), rgba(30,30,60,0.9));
            padding: 40px;
            border-radius: 20px;
            margin-bottom: 20px;
            border: 1px solid #4338ca;
            box-shadow: 0 15px 35px rgba(0,0,0,0.2);
            position: relative;
            overflow: hidden;
        }

        .scenario-container::before {
            content: '';
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 3px;
            background: linear-gradient(90deg, #ef4444, #f59e0b, #10b981, #06b6d4, #8b5cf6);
        }

        .scenario-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 25px;
        }

        .scenario-badge {
            font-family: 'Orbitron', monospace;
            background: linear-gradient(135deg, #8b5cf6, #6366f1);
            padding: 8px 16px;
            border-radius: 15px;
            font-weight: 700;
            font-size: 0.9em;
            text-transform: uppercase;
            letter-spacing: 0.5px;
        }

        .risk-indicator {
            display: flex;
            align-items: center;
            gap: 5px;
            font-size: 0.9em;
            color: #fbbf24;
        }

        .story-context {
            background: rgba(139, 92, 246, 0.1);
            border-left: 4px solid #8b5cf6;
            padding: 20px;
            margin-bottom: 25px;
            border-radius: 0 10px 10px 0;
            font-style: italic;
            color: #c7d2fe;
        }

        .research-challenge {
            font-size: 1.3em;
            color: #e2e8f0;
            margin-bottom: 30px;
            font-weight: 500;
            line-height: 1.6;
        }

        .decision-options {
            margin-bottom: 30px;
        }

        .decision-option {
            background: rgba(0,0,0,0.6);
            border: 2px solid #374151;
            padding: 25px;
            margin-bottom: 15px;
            border-radius: 12px;
            cursor: pointer;
            transition: all 0.3s ease;
            position: relative;
            overflow: hidden;
        }

        .decision-option::before {
            content: '';
            position: absolute;
            top: 0;
            left: -100%;
            width: 100%;
            height: 100%;
            background: linear-gradient(90deg, transparent, rgba(79, 209, 199, 0.1), transparent);
            transition: left 0.3s;
        }

        .decision-option:hover::before {
            left: 100%;
        }

        .decision-option:hover {
            border-color: #4fd1c7;
            transform: translateX(10px);
        }

        .decision-option.selected {
            border-color: #4fd1c7;
            background: rgba(79, 209, 199, 0.1);
        }

        .decision-option.correct {
            border-color: #10b981;
            background: rgba(16, 185, 129, 0.1);
        }

        .decision-option.incorrect {
            border-color: #ef4444;
            background: rgba(239, 68, 68, 0.1);
        }

        .option-header {
            display: flex;
            align-items: center;
            margin-bottom: 10px;
        }

        .option-letter {
            background: linear-gradient(135deg, #4fd1c7, #06b6d4);
            color: #0f172a;
            width: 35px;
            height: 35px;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            margin-right: 15px;
            font-family: 'Orbitron', monospace;
            font-weight: 700;
        }

        .decision-option.correct .option-letter {
            background: linear-gradient(135deg, #10b981, #059669);
        }

        .decision-option.incorrect .option-letter {
            background: linear-gradient(135deg, #ef4444, #dc2626);
            color: white;
        }

        .consequence-analysis {
            background: linear-gradient(135deg, rgba(0,0,0,0.8), rgba(30,30,60,0.8));
            padding: 25px;
            border-radius: 12px;
            margin-top: 25px;
            border-left: 4px solid #4fd1c7;
            position: relative;
        }

        .consequence-analysis::before {
            content: "📊";
            position: absolute;
            top: 20px;
            right: 20px;
            font-size: 1.8em;
        }

        .analysis-title {
            font-family: 'Orbitron', monospace;
            color: #4fd1c7;
            margin-bottom: 15px;
            font-weight: 700;
        }

        .impact-summary {
            background: rgba(79, 209, 199, 0.1);
            padding: 15px;
            border-radius: 8px;
            margin-top: 15px;
            border-left: 3px solid #4fd1c7;
        }

        .mission-controls {
            display: flex;
            justify-content: space-between;
            gap: 15px;
            margin-top: 30px;
        }

        .control-btn {
            padding: 12px 25px;
            border: none;
            border-radius: 25px;
            font-family: 'Rajdhani', sans-serif;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s ease;
            text-transform: uppercase;
            letter-spacing: 0.5px;
            position: relative;
            overflow: hidden;
        }

        .control-btn::before {
            content: '';
            position: absolute;
            top: 0;
            left: -100%;
            width: 100%;
            height: 100%;
            background: linear-gradient(90deg, transparent, rgba(255,255,255,0.2), transparent);
            transition: left 0.5s;
        }

        .control-btn:hover::before {
            left: 100%;
        }

        .btn-primary {
            background: linear-gradient(135deg, #8b5cf6, #6366f1);
            color: white;
        }

        .btn-secondary {
            background: rgba(0,0,0,0.6);
            color: #94a3b8;
            border: 1px solid #374151;
        }

        .btn-primary:hover {
            transform: translateY(-3px);
            box-shadow: 0 8px 25px rgba(139, 92, 246, 0.4);
        }

        .btn-secondary:hover {
            background: rgba(30,30,60,0.8);
            border-color: #4fd1c7;
            color: #e2e8f0;
        }

        .control-btn:disabled {
            opacity: 0.5;
            cursor: not-allowed;
            transform: none !important;
        }

        .mission-results {
            text-align: center;
            padding: 50px 40px;
        }

        .final-score {
            font-family: 'Orbitron', monospace;
            font-size: 4em;
            font-weight: 900;
            background: linear-gradient(135deg, #4fd1c7, #8b5cf6);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            margin-bottom: 20px;
        }

        .mission-outcome {
            font-size: 1.5em;
            color: #94a3b8;
            margin-bottom: 30px;
            font-weight: 500;
        }

        .achievements {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
            gap: 25px;
            margin-top: 40px;
        }

        .achievement-card {
            background: rgba(0,0,0,0.7);
            padding: 25px;
            border-radius: 15px;
            border: 2px solid #374151;
            transition: all 0.3s ease;
        }

        .achievement-card.unlocked {
            border-color: #10b981;
            background: rgba(16, 185, 129, 0.1);
        }

        .achievement-card:hover {
            transform: translateY(-5px);
        }

        .achievement-icon {
            font-size: 2em;
            margin-bottom: 10px;
        }

        .achievement-name {
            font-family: 'Orbitron', monospace;
            font-weight: 700;
            margin-bottom: 8px;
        }

        .achievement-desc {
            color: #9ca3af;
            font-size: 0.9em;
        }

        .hidden {
            display: none;
        }

        @media (max-width: 768px) {
            .container {
                padding: 15px;
            }
            
            .difficulty-selection {
                grid-template-columns: 1fr;
            }
            
            .mission-length {
                flex-direction: column;
                align-items: center;
            }
            
            .mission-controls {
                flex-direction: column;
            }
            
            .achievements {
                grid-template-columns: 1fr;
            }
        }
    </style>
</head>
<body>
    <div class="stars"></div>
    <div class="container">
        <div class="game-header">
            <h1 class="game-title">The InQUIZitive MIDDler</h1>
            <p class="game-subtitle">Regulatory Chronicles</p>
        </div>

        <!-- Player Stats -->
        <div id="playerStats" class="player-stats hidden">
            <div class="stat-card">
                <div class="stat-label">Regulatory Knowledge</div>
                <div class="stat-value" id="knowledgeValue">100</div>
                <div class="stat-bar">
                    <div class="stat-fill" id="knowledgeFill" style="width: 100%"></div>
                </div>
            </div>
            <div class="stat-card">
                <div class="stat-label">Development Budget</div>
                <div class="stat-value" id="budgetValue">$25M</div>
                <div class="stat-bar">
                    <div class="stat-fill" id="budgetFill" style="width: 100%"></div>
                </div>
            </div>
            <div class="stat-card">
                <div class="stat-label">FDA/EMA Standing</div>
                <div class="stat-value" id="reputationValue">Trusted</div>
                <div class="stat-bar">
                    <div class="stat-fill" id="reputationFill" style="width: 75%"></div>
                </div>
            </div>
            <div class="stat-card">
                <div class="stat-label">Submission Pressure</div>
                <div class="stat-value" id="timeValue">Moderate</div>
                <div class="stat-bar">
                    <div class="stat-fill" id="timeFill" style="width: 25%"></div>
                </div>
            </div>
        </div>

        <!-- Mission Setup -->
        <div id="missionSetup" class="mission-setup">
            <h2 class="mission-title">🏛️ Select Your Regulatory Mission</h2>
            <p style="text-align: center; color: #94a3b8; margin-bottom: 30px;">You are Dr. Alex Chen, Senior PBPK Modeler at The InQUIZitive MIDDler's drug development division. Master advanced modeling challenges, AI-enhanced predictions, and complex absorption mechanisms to accelerate drug discovery.</p>
            
            <div class="difficulty-selection">
                <div class="difficulty-card" onclick="selectDifficulty('rookie_scientist')">
                    <div class="difficulty-header">
                        <span class="difficulty-icon">🤖</span>
                        <span class="difficulty-name">Rookie Scientist</span>
                    </div>
                    <div class="difficulty-description">
                        New to PBPK modeling. Learn AI-PBPK foundations, absorption modeling, solubility-limited processes, and IVIVE scaling principles.
                    </div>
                    <div class="difficulty-rewards">
                        💡 AI-PBPK Training | 🔬 Absorption Fundamentals | ⏱️ Learning Focus
                    </div>
                </div>
                
                <div class="difficulty-card" onclick="selectDifficulty('veteran_researcher')">
                    <div class="difficulty-header">
                        <span class="difficulty-icon">📊</span>
                        <span class="difficulty-name">Veteran Researcher</span>
                    </div>
                    <div class="difficulty-description">
                        Experienced modeler tackling complex DDI predictions, special populations, and advanced mechanistic modeling challenges.
                    </div>
                    <div class="difficulty-rewards">
                        🎯 Advanced PBPK Mastery | 🧬 DDI Expertise | 💼 Industry Recognition
                    </div>
                </div>
                
                <div class="difficulty-card" onclick="selectDifficulty('legend_hunter')">
                    <div class="difficulty-header">
                        <span class="difficulty-icon">⚖️</span>
                        <span class="difficulty-name">Drug Hunter Legend</span>
                    </div>
                    <div class="difficulty-description">
                        Elite modeling expert. Master cutting-edge AI-PBPK integration, novel mechanisms, and industry-defining methodologies.
                    </div>
                    <div class="difficulty-rewards">
                        🏆 Legendary Status | 🚀 Innovation Leadership | 🌍 Scientific Impact
                    </div>
                </div>
            </div>
            
            <div class="mission-length">
                <div class="length-option" onclick="selectLength(10)">
                    <strong>Rapid Assessment</strong><br>
                    <small>10 Regulatory Decisions</small><br>
                    <small>~15 minutes</small>
                </div>
                <div class="length-option" onclick="selectLength(20)">
                    <strong>Submission Review</strong><br>
                    <small>20 Strategic Challenges</small><br>
                    <small>~30 minutes</small>
                </div>
                <div class="length-option" onclick="selectLength(30)">
                    <strong>Regulatory Marathon</strong><br>
                    <small>30 Critical Decisions</small><br>
                    <small>~45 minutes</small>
                </div>
            </div>
            
            <button id="launchMissionBtn" class="launch-mission" onclick="launchMission()" disabled>
                🚀 Begin Regulatory Mission
            </button>
        </div>

        <!-- Game Progress -->
        <div id="gameProgress" class="game-progress hidden">
            <div class="progress-header">
                <div class="mission-info" id="missionInfo">Regulatory Progress</div>
                <div class="mission-info" id="difficultyDisplay">Regulatory Scientist Level</div>
            </div>
            <div class="progress-bar">
                <div id="progressFill" class="progress-fill" style="width: 0%"></div>
            </div>
        </div>

        <!-- Scenario Container -->
        <div id="scenarioContainer" class="scenario-container hidden">
            <div class="scenario-header">
                <div class="scenario-badge" id="scenarioBadge">Regulatory Challenge #1</div>
                <div class="risk-indicator">
                    <span>⚠️</span>
                    <span id="riskLevel">Medium Risk</span>
                </div>
            </div>
            
            <div id="storyContext" class="story-context"></div>
            <div id="researchChallenge" class="research-challenge"></div>
            
            <div id="decisionOptions" class="decision-options"></div>
            
            <div id="consequenceAnalysis" class="consequence-analysis hidden">
                <h4 class="analysis-title">📊 Regulatory Impact Analysis</h4>
                <p id="analysisText"></p>
                <div id="impactSummary" class="impact-summary hidden"></div>
            </div>
            
            <div class="mission-controls">
                <button id="prevMissionBtn" class="control-btn btn-secondary" onclick="previousScenario()" disabled>
                    ← Previous
                </button>
                <button id="nextMissionBtn" class="control-btn btn-primary" onclick="nextScenario()" disabled>
                    Continue Review →
                </button>
                <button id="completeMissionBtn" class="control-btn btn-primary hidden" onclick="completeMission()">
                    Submit to Agency 📤
                </button>
            </div>
        </div>

        <!-- Mission Results -->
        <div id="missionResults" class="scenario-container mission-results hidden">
            <h2>🎯 Regulatory Mission Complete</h2>
            <div id="finalScore" class="final-score"></div>
            <div id="missionOutcome" class="mission-outcome"></div>
            
            <div class="achievements">
                <div class="achievement-card" id="accuracyAchievement">
                    <div class="achievement-icon">🎯</div>
                    <div class="achievement-name">Regulatory Expert</div>
                    <div class="achievement-desc">Achieved 80%+ accuracy on regulatory decisions</div>
                </div>
                <div class="achievement-card" id="speedAchievement">
                    <div class="achievement-icon">⚡</div>
                    <div class="achievement-name">Efficient Reviewer</div>
                    <div class="achievement-desc">Completed submission review in record time</div>
                </div>
                <div class="achievement-card" id="perfectionAchievement">
                    <div class="achievement-icon">🏆</div>
                    <div class="achievement-name">Perfect Submission</div>
                    <div class="achievement-desc">100% regulatory compliance achieved</div>
                </div>
                <div class="achievement-card" id="riskTakerAchievement">
                    <div class="achievement-icon">⚖️</div>
                    <div class="achievement-name">Authority Figure</div>
                    <div class="achievement-desc">Mastered Regulatory Authority level</div>
                </div>
            </div>
            
            <div class="mission-controls" style="margin-top: 40px;">
                <button class="control-btn btn-primary" onclick="newMission()">🎮 New Mission</button>
                <button class="control-btn btn-secondary" onclick="reviewScenarios()">📋 Review Decisions</button>
            </div>
        </div>
    </div>

    <script>
        // Game state variables
        let gameStats = {
            knowledge: 100,
            budget: 25000000,
            reputation: 75,
            timePressure: 25
        };
        
        let selectedDifficulty = '';
        let selectedLength = 0;
        let currentScenarios = [];
        let currentScenario = 0;
        let playerChoices = [];
        let missionStartTime = 0;
        let missionActive = false;
        let missionCompleted = false;

        // Enhanced question pools focused on PBPK modeling and AI integration
        const scenarioPools = {
            rookie_scientist: [
                {
                    context: "🤖 AI-PBPK Training: Your team is implementing machine learning to predict tissue partition coefficients (Kp). The Poulin & Theil method shows systematic bias for basic compounds.",
                    challenge: "For a basic compound (pKa = 8.5, logP = 3.2), your AI model predicts brain Kp = 0.35, but experimental data shows Kp = 0.12. What's the most likely mechanistic explanation?",
                    risk: "Low",
                    options: [
                        "AI model overestimates passive permeability across blood-brain barrier",
                        "P-glycoprotein efflux reduces brain accumulation below passive predictions", 
                        "Brain tissue binding is higher than predicted from physicochemical properties",
                        "Microsomal protein binding artifacts inflate the apparent Kp value"
                    ],
                    correct: 1,
                    analysis: "Excellent mechanistic insight! Basic compounds (pKa 8.5) are predominantly ionized at physiological pH, making them prime P-gp substrates. The 3-fold discrepancy (0.35 vs 0.12) is classic for efflux transport limiting brain penetration. AI models trained on passive data miss active transport effects.",
                    impact: "🧠 P-gp mechanism identified | 🤖 AI model limitation understood | 🎯 Transporter integration needed",
                    consequences: {
                        budget: 50000,
                        knowledge: 15,
                        reputation: 10,
                        time: 5
                    }
                },
                {
                    context: "📊 Absorption Modeling: Your BCS Class II compound shows poor oral bioavailability (F = 12%). Dissolution rate is solubility-limited with tmax = 4.5 hours.",
                    challenge: "Using ACAT modeling principles, which mechanistic parameter would most improve bioavailability predictions for solubility-limited absorption?",
                    risk: "Medium",
                    options: [
                        "Increasing effective permeability (Peff) in the small intestine",
                        "Accounting for bile acid-mediated solubilization enhancement",
                        "Including gastric pH effects on dissolution kinetics", 
                        "Modeling particle size distribution effects on surface area"
                    ],
                    correct: 1,
                    analysis: "Outstanding! For BCS Class II compounds, solubility is the rate-limiting step. Bile acids form mixed micelles that dramatically enhance apparent solubility (up to 10-fold increases). The late tmax (4.5h) indicates slow dissolution limited by aqueous solubility, which bile acid modeling would address mechanistically.",
                    impact: "💊 Solubility mechanism clarified | 🔬 ACAT model enhanced | 📈 Bioavailability prediction improved",
                    consequences: {
                        budget: 25000,
                        knowledge: 18,
                        reputation: 12,
                        time: 8
                    }
                },
                {
                    context: "🧬 IVIVE Scaling: Your hepatic clearance predictions consistently overestimate by 5-fold. CLint,microsomes = 125 μL/min/mg protein, but predicted CLh = 18 L/h vs observed CLh = 3.8 L/h.",
                    challenge: "Which IVIVE scaling factor correction would most likely resolve this systematic over-prediction?",
                    risk: "Medium",
                    options: [
                        "Reduce MPPGL from 40 to 32 mg/g liver for inter-individual variability",
                        "Apply microsomal protein binding correction (fu,mic = 0.23)",
                        "Include cytosolic binding effects reducing free drug concentration",
                        "Account for relative expression factor (REF) between microsomes and hepatocytes"
                    ],
                    correct: 1,
                    analysis: "Brilliant diagnosis! Microsomal protein binding (fu,mic) is often the largest systematic error in IVIVE scaling. With fu,mic = 0.23, the effective intrinsic clearance becomes 125 × 0.23 = 29 μL/min/mg, reducing predicted clearance by 4.3-fold—closely matching your observation!",
                    impact: "⚗️ IVIVE accuracy improved | 🎯 Protein binding mechanism understood | 📊 Scaling factor optimized",
                    consequences: {
                        budget: 75000,
                        knowledge: 20,
                        reputation: 15,
                        time: 10
                    }
                },
                {
                    context: "🤖 Neural-ODE Implementation: You're implementing Neural Ordinary Differential Equations for PK prediction. The model learns ODE parameters directly from concentration-time data.",
                    challenge: "What's the primary advantage of Neural-ODEs over traditional machine learning for PBPK parameter estimation?",
                    risk: "Low", 
                    options: [
                        "Better handling of irregular time sampling in clinical datasets",
                        "Reduced computational requirements for training",
                        "Automatic feature selection from molecular descriptors",
                        "Elimination of need for mechanistic model structure"
                    ],
                    correct: 0,
                    analysis: "Perfect! Neural-ODEs excel with irregular time intervals, a major limitation of traditional RNNs/LSTMs that require fixed time grids. Clinical PK data has sparse, irregular sampling, making Neural-ODEs ideal for learning continuous dynamics from real-world datasets.",
                    impact: "🧠 Neural-ODE advantage understood | ⏰ Irregular sampling handled | 🎯 AI architecture optimized",
                    consequences: {
                        budget: 40000,
                        knowledge: 16,
                        reputation: 8,
                        time: 6
                    }
                },
                {
                    context: "📈 Dissolution Modeling: Your immediate-release tablet shows pH-dependent dissolution. At pH 1.2: 85% dissolved in 30 min. At pH 6.8: 23% dissolved in 2 hours.",
                    challenge: "This dissolution profile is most consistent with which compound characteristics?",
                    risk: "Low",
                    options: [
                        "Weak acid with pKa around 4.5-5.5",
                        "Weak base salt form with pKa around 8-9", 
                        "Neutral compound with pH-independent solubility",
                        "Ampholyte with isoelectric point near pH 6.8"
                    ],
                    correct: 1,
                    analysis: "Excellent analysis! The dramatic pH-dependent dissolution (85% at pH 1.2 vs 23% at pH 6.8) indicates a weak base salt. At low pH, the compound is ionized and highly soluble. As pH increases toward the pKa (~8-9), ionization decreases, reducing solubility and dissolution rate.",
                    impact: "🧪 pH-solubility relationship mastered | 💊 Salt form behavior understood | 🎯 Formulation strategy clarified",
                    consequences: {
                        budget: 30000,
                        knowledge: 17,
                        reputation: 11,
                        time: 7
                    }
                },
                {
                    context: "🔬 Machine Learning Integration: Your AI-PBPK platform uses Graph Neural Networks (GNNs) to predict ADME parameters from molecular structure.",
                    challenge: "Why are GNNs particularly well-suited for structure-based PBPK parameter prediction compared to traditional molecular descriptors?",
                    risk: "Medium",
                    options: [
                        "GNNs automatically capture topological relationships between atoms",
                        "Reduced computational overhead for large molecular datasets",
                        "Better handling of categorical molecular properties",
                        "Elimination of need for 3D conformational information"
                    ],
                    correct: 0,
                    analysis: "Superb! GNNs excel because they learn from molecular graph structure, automatically capturing atom connectivity, bond types, and local chemical environments. This provides richer representation than fixed descriptors, allowing the model to discover structure-property relationships relevant for PBPK parameters.",
                    impact: "🕸️ GNN architecture mastered | 🧬 Molecular representation optimized | 🤖 AI-PBPK integration advanced",
                    consequences: {
                        budget: 60000,
                        knowledge: 19,
                        reputation: 13,
                        time: 9
                    }
                }
            ],
            veteran_researcher: [
                {
                    context: "🧬 Complex DDI Network: Your oncology drug inhibits CYP3A4 (Ki = 0.8 μM) and induces CYP2C9 (EC50 = 2.1 μM) simultaneously. Clinical dose achieves Css = 3.2 μM.",
                    challenge: "For warfarin co-administration (CYP2C9 substrate), your PBPK model should predict what net effect?",
                    risk: "High",
                    options: [
                        "Net induction effect reducing warfarin exposure by 40-60%",
                        "Competing effects canceling out with minimal net change (<20%)",
                        "Time-dependent transition from inhibition to induction over 7-14 days",
                        "Inhibition dominant due to higher warfarin affinity for CYP2C9"
                    ],
                    correct: 2,
                    analysis: "Outstanding pharmacology insight! With Css (3.2 μM) > EC50 (2.1 μM), induction will be significant, but induction takes time for enzyme synthesis. Initially, you'd see inhibition effects, then gradual transition to net induction as new enzyme is synthesized. This temporal pattern is critical for clinical management.",
                    impact: "⏰ Time-dependent DDI mastered | 🧬 Enzyme kinetics understood | ⚖️ Clinical relevance achieved",
                    consequences: {
                        budget: 200000,
                        knowledge: 25,
                        reputation: 20,
                        time: 15
                    }
                },
                {
                    context: "🎯 AI-Enhanced Prediction: Your ensemble ML model combines Random Forest and Neural Networks for Kp prediction. Cross-validation R² = 0.78, but external validation R² = 0.52.",
                    challenge: "This performance discrepancy most likely indicates which modeling issue that impacts PBPK predictions?",
                    risk: "High",
                    options: [
                        "Overfitting to training chemical space with poor generalization",
                        "Insufficient training data leading to high model variance", 
                        "Feature selection bias toward correlated molecular descriptors",
                        "Inadequate hyperparameter tuning during model development"
                    ],
                    correct: 0,
                    analysis: "Excellent diagnosis! The large gap between cross-validation (0.78) and external validation (0.52) is classic overfitting. Your ensemble learned training set peculiarities rather than generalizable structure-property relationships. This limits PBPK model utility for novel chemical series.",
                    impact: "🎯 Overfitting identified | 🧪 Generalization improved | 🤖 Model robustness enhanced",
                    consequences: {
                        budget: -100000,
                        knowledge: 24,
                        reputation: 18,
                        time: 12
                    }
                },
                {
                    context: "💊 Pediatric PBPK Challenge: Your adult model needs scaling for ages 2-12. CYP3A4 substrate with extensive hepatic metabolism (fm,CYP3A4 = 0.85).",
                    challenge: "At age 6, which ontogeny scaling approach provides the most mechanistically sound clearance prediction?",
                    risk: "High",
                    options: [
                        "Linear scaling: CLchild = CLadult × (Weight_child/Weight_adult)",
                        "Allometric scaling: CLchild = CLadult × (Weight_child/Weight_adult)^0.75",
                        "Ontogeny function: CLchild = CLadult × Ontogeny_factor(age=6) × Weight_scaling",
                        "Surface area scaling: CLchild = CLadult × (BSA_child/BSA_adult)"
                    ],
                    correct: 2,
                    analysis: "Outstanding pediatric pharmacology! CYP3A4 ontogeny is complex—expression at age 6 is ~60% of adult levels. Simple weight scaling ignores enzymatic immaturity. The ontogeny function approach accounts for both developmental enzyme expression AND size scaling, providing physiologically realistic predictions.",
                    impact: "👶 Pediatric ontogeny mastered | 🧬 CYP3A4 development understood | 🎯 Age-appropriate dosing enabled",
                    consequences: {
                        budget: 300000,
                        knowledge: 28,
                        reputation: 22,
                        time: 18
                    }
                },
                {
                    context: "🔬 Transporter-Mediated DDI: Your OATP1B1 substrate shows 4.2-fold AUC increase with rifampin co-administration, but your static DDI model predicts only 1.8-fold.",
                    challenge: "What mechanistic refinement would most improve your PBPK DDI prediction accuracy?",
                    risk: "High",
                    options: [
                        "Include OATP1B3 inhibition in addition to OATP1B1",
                        "Account for rifampin's metabolite (25-desacetyl) inhibition potency",
                        "Model concentration-dependent inhibition using unbound liver concentration",
                        "Add efflux transporter (MRP2/4) inhibition to the hepatic model"
                    ],
                    correct: 2,
                    analysis: "Brilliant mechanistic insight! Rifampin achieves very high liver concentrations (~100× plasma levels) due to OATP uptake. Using unbound liver concentration for Ki assessment captures the true inhibition potential at the transporter site, explaining the stronger clinical DDI than plasma-based predictions suggest.",
                    impact: "🎯 Hepatic concentration gradients understood | 🧬 Transporter DDI mechanics mastered | 📊 Prediction accuracy improved",
                    consequences: {
                        budget: 150000,
                        knowledge: 26,
                        reputation: 21,
                        time: 16
                    }
                },
                {
                    context: "⚗️ Biopharmaceutics Challenge: Your BCS Class IV compound (low solubility, low permeability) needs bioavailability enhancement. Current F = 8%.",
                    challenge: "Which PBPK modeling approach would best guide formulation strategy for this challenging compound?",
                    risk: "High", 
                    options: [
                        "ACAT model with regional permeability and pH-dependent solubility",
                        "Dissolution-precipitation model with supersaturation kinetics",
                        "Particle size distribution model with surface area effects",
                        "Lipid-based formulation model with mixed micelle formation"
                    ],
                    correct: 3,
                    analysis: "Excellent strategic thinking! For BCS Class IV compounds, both solubility and permeability are limiting. Lipid-based formulations (LBF) can simultaneously enhance both: creating supersaturated solutions that increase thermodynamic activity (driving permeation) while maintaining dissolved drug through mixed micelle formation.",
                    impact: "💊 BCS Class IV strategy mastered | 🧪 Lipid formulation modeling | 📈 Bioavailability enhancement pathway",
                    consequences: {
                        budget: 250000,
                        knowledge: 27,
                        reputation: 23,
                        time: 17
                    }
                },
                {
                    context: "🤖 Advanced AI Integration: You're implementing transfer learning to adapt PBPK models across species. Mouse-to-human scaling shows consistent 3-fold clearance under-prediction.",
                    challenge: "Which mechanistic difference most likely explains this systematic scaling error in your AI-enhanced PBPK approach?",
                    risk: "High",
                    options: [
                        "Species differences in microsomal protein per gram liver (MPPGL)",
                        "Hepatocyte size differences affecting intracellular drug concentrations",
                        "CYP enzyme expression level variations between species",
                        "Plasma protein binding differences altering free drug fractions"
                    ],
                    correct: 0,
                    analysis: "Outstanding cross-species insight! MPPGL varies significantly: mouse (~45 mg/g) vs human (~32 mg/g). This 40% difference would cause systematic over-prediction of human clearance from mouse data. Your AI model needs species-specific scaling factors to account for these physiological differences.",
                    impact: "🐭 Cross-species scaling mastered | 🤖 AI model calibrated | 🧬 Physiological differences accounted",
                    consequences: {
                        budget: 180000,
                        knowledge: 29,
                        reputation: 24,
                        time: 19
                    }
                }
            ],
            legend_hunter: [
                {
                    context: "🚨 BREAKTHROUGH CHALLENGE: Your AI-PBPK platform discovered a novel absorption mechanism for a cyclic peptide. Traditional models predict F < 1%, but clinical data shows F = 23%.",
                    challenge: "The AI identified co-administration with endogenous bile acids increases paracellular transport. What's the most likely mechanistic pathway enabling this unexpected bioavailability?",
                    risk: "Critical",
                    options: [
                        "Bile acid-induced tight junction modulation via claudin-2 upregulation",
                        "Formation of bile acid-peptide co-micelles enhancing transcellular uptake",
                        "P-glycoprotein inhibition by secondary bile acids reducing efflux",
                        "Peptidase inhibition in enterocytes preventing presystemic metabolism"
                    ],
                    correct: 0,
                    analysis: "REVOLUTIONARY INSIGHT! Bile acids can modulate tight junction permeability through claudin-2 regulation, creating a paracellular pathway for hydrophilic peptides. This mechanism bypasses traditional transcellular limitations and explains the dramatic bioavailability enhancement your AI discovered. This could revolutionize peptide delivery strategies!",
                    impact: "🔬 Novel mechanism discovered | 🧬 Paracellular transport mastered | 💊 Peptide delivery breakthrough | 🏆 Scientific paradigm shift",
                    consequences: {
                        budget: 500000,
                        knowledge: 35,
                        reputation: 40,
                        time: 25
                    }
                },
                {
                    context: "⚡ NEURAL-ODE MASTERY: Your cutting-edge Neural-ODE PBPK system learns population variability patterns from sparse clinical data. The model predicts individual PK profiles with 89% accuracy.",
                    challenge: "To achieve FDA qualification for this AI-PBPK platform, what's the most critical validation requirement for regulatory acceptance?",
                    risk: "Critical",
                    options: [
                        "Demonstrate mechanistic interpretability of learned ODE parameters",
                        "Validate against prospective clinical trial data from independent populations",
                        "Show superior performance to traditional PBPK across multiple compounds",
                        "Quantify prediction uncertainty with confidence intervals"
                    ],
                    correct: 1,
                    analysis: "MASTERFUL understanding of AI validation! Regulatory agencies require prospective validation on completely independent datasets to prove generalizability beyond training data. Your 89% retrospective accuracy is impressive, but FDA acceptance demands demonstrated performance on new clinical studies with different populations and study designs.",
                    impact: "⚖️ FDA AI pathway understood | 🎯 Validation strategy optimized | 🤖 Neural-ODE regulation mastered | 📊 Prospective validation planned",
                    consequences: {
                        budget: 750000,
                        knowledge: 38,
                        reputation: 42,
                        time: 28
                    }
                },
                {
                    context: "🧬 SYSTEMS PHARMACOLOGY: Your multi-scale PBPK model integrates tissue-level metabolism with cellular transporter dynamics. The model captures non-linear PK saturation at therapeutic doses.",
                    challenge: "For a compound showing Michaelis-Menten kinetics in both hepatic uptake (OATP1B1) and metabolism (CYP2C8), which parameter interaction most critically determines non-linear clearance?",
                    risk: "Critical",
                    options: [
                        "Ratio of transporter Km to enzyme Km values",
                        "Relative expression levels of OATP1B1 vs CYP2C8 in hepatocytes",
                        "Competition between uptake velocity and metabolic velocity",
                        "Intracellular drug concentration approaching both Km values simultaneously"
                    ],
                    correct: 3,
                    analysis: "LEGENDARY systems thinking! When intracellular concentration approaches both the transporter Km and enzyme Km simultaneously, you get complex non-linear behavior where uptake and metabolism compete for the same drug molecules. This creates concentration-dependent clearance patterns that require sophisticated PBPK modeling to predict accurately.",
                    impact: "🧠 Systems-level integration achieved | ⚗️ Transporter-enzyme interplay mastered | 📈 Non-linear kinetics predicted | 🎯 Therapeutic window optimized",
                    consequences: {
                        budget: 600000,
                        knowledge: 40,
                        reputation: 45,
                        time: 30
                    }
                },
                {
                    context: "🎯 PRECISION MEDICINE: Your AI-PBPK platform integrates pharmacogenomics, disease state, and co-medication effects to predict individual drug exposure. The model accounts for 847 genetic variants.",
                    challenge: "For CYP2D6 poor metabolizers taking your drug (fm,CYP2D6 = 0.65) with quinidine co-medication, which mechanistic consideration is most critical for accurate exposure prediction?",
                    risk: "Critical",
                    options: [
                        "Compensatory clearance through minor metabolic pathways (CYP3A4, CYP2C19)",
                        "Altered tissue distribution due to changed protein binding patterns",
                        "Renal clearance changes from accumulation of parent compound",
                        "Time-dependent inhibition kinetics of quinidine on residual CYP2D6 activity"
                    ],
                    correct: 0,
                    analysis: "BRILLIANT precision medicine insight! In CYP2D6 poor metabolizers, minor pathways become critical for clearance. With 65% metabolism normally through CYP2D6, alternative routes (CYP3A4, CYP2C19) must handle the entire metabolic burden. Your AI model must accurately predict this pathway switching to avoid dangerous exposure increases.",
                    impact: "🧬 Pharmacogenomic compensation mastered | 🎯 Individual prediction achieved | 💊 Personalized dosing enabled | 🏆 Precision medicine advanced",
                    consequences: {
                        budget: 800000,
                        knowledge: 42,
                        reputation: 47,
                        time: 32
                    }
                },
                {
                    context: "🚀 NEXT-GENERATION MODELING: Your team developed the first quantum-enhanced PBPK model using quantum machine learning for molecular property prediction. Initial results show 94% accuracy.",
                    challenge: "What represents the most significant advantage of quantum-enhanced approaches for complex PBPK parameter estimation?",
                    risk: "Critical",
                    options: [
                        "Exponential speedup in molecular descriptor calculations",
                        "Ability to model quantum effects in drug-protein interactions",
                        "Enhanced pattern recognition in high-dimensional chemical space",
                        "Simultaneous optimization of multiple correlated PBPK parameters"
                    ],
                    correct: 2,
                    analysis: "VISIONARY understanding! Quantum machine learning excels at finding patterns in exponentially large, high-dimensional spaces—exactly what's needed for chemical space exploration. Traditional computers struggle with the combinatorial complexity of molecular property relationships, but quantum systems can naturally handle these multi-dimensional correlations for PBPK parameter prediction.",
                    impact: "🔮 Quantum computing mastered | 🌌 High-dimensional space navigation | 🧬 Molecular complexity conquered | 🏆 Future technology leadership",
                    consequences: {
                        budget: 1000000,
                        knowledge: 45,
                        reputation: 50,
                        time: 35
                    }
                }
            ]
        };

        function selectDifficulty(difficulty) {
            selectedDifficulty = difficulty;
            document.querySelectorAll('.difficulty-card').forEach(card => card.classList.remove('selected'));
            event.target.closest('.difficulty-card').classList.add('selected');
            
            // Update stats based on difficulty
            updateStatsForDifficulty(difficulty);
            updateLaunchButton();
        }

        function selectLength(length) {
            selectedLength = length;
            document.querySelectorAll('.length-option').forEach(option => option.classList.remove('selected'));
            event.target.closest('.length-option').classList.add('selected');
            updateLaunchButton();
        }

        function updateStatsForDifficulty(difficulty) {
            const stats = {
                development_associate: { knowledge: 100, budget: 30000000, reputation: 50, timePressure: 15 },
                regulatory_scientist: { knowledge: 100, budget: 25000000, reputation: 75, timePressure: 25 },
                regulatory_authority: { knowledge: 100, budget: 20000000, reputation: 90, timePressure: 40 }
            };
            
            gameStats = { ...stats[difficulty] };
            updateStatsDisplay();
        }

        function updateStatsDisplay() {
            document.getElementById('knowledgeValue').textContent = gameStats.knowledge;
            document.getElementById('budgetValue').textContent = `$${(gameStats.budget / 1000000).toFixed(0)}M`;
            document.getElementById('knowledgeFill').style.width = `${gameStats.knowledge}%`;
            document.getElementById('budgetFill').style.width = `${Math.max(0, gameStats.budget / 30000000 * 100)}%`;
            
            // Reputation display
            const repNames = { 0: 'Unknown', 25: 'Junior', 50: 'Trusted', 75: 'Expert', 90: 'Authority', 100: 'Legend' };
            const repLevel = Object.keys(repNames).reverse().find(level => gameStats.reputation >= level);
            document.getElementById('reputationValue').textContent = repNames[repLevel];
            document.getElementById('reputationFill').style.width = `${gameStats.reputation}%`;
            
            // Time pressure
            const timeNames = { 0: 'Relaxed', 25: 'Moderate', 50: 'Urgent', 75: 'High', 90: 'Critical' };
            const timeLevel = Object.keys(timeNames).reverse().find(level => gameStats.timePressure >= level);
            document.getElementById('timeValue').textContent = timeNames[timeLevel];
            document.getElementById('timeFill').style.width = `${gameStats.timePressure}%`;
        }

        function updateLaunchButton() {
            const btn = document.getElementById('launchMissionBtn');
            btn.disabled = !(selectedDifficulty && selectedLength);
        }

        function launchMission() {
            const pool = scenarioPools[selectedDifficulty];
            currentScenarios = shuffleArray([...pool]).slice(0, Math.min(selectedLength, pool.length));
            playerChoices = new Array(currentScenarios.length).fill(null);
            
            // Hide setup, show game
            document.getElementById('missionSetup').classList.add('hidden');
            document.getElementById('playerStats').classList.remove('hidden');
            document.getElementById('gameProgress').classList.remove('hidden');
            document.getElementById('scenarioContainer').classList.remove('hidden');
            
            // Initialize game state
            missionActive = true;
            currentScenario = 0;
            missionStartTime = Date.now();
            
            const difficultyNames = {
                development_associate: 'Development Associate',
                regulatory_scientist: 'Regulatory Scientist', 
                regulatory_authority: 'Regulatory Authority'
            };
            document.getElementById('difficultyDisplay').textContent = difficultyNames[selectedDifficulty] + ' Level';
            
            displayScenario();
            updateProgress();
        }

        function shuffleArray(array) {
            for (let i = array.length - 1; i > 0; i--) {
                const j = Math.floor(Math.random() * (i + 1));
                [array[i], array[j]] = [array[j], array[i]];
            }
            return array;
        }

        function displayScenario() {
            const scenario = currentScenarios[currentScenario];
            
            // Update header
            document.getElementById('scenarioBadge').textContent = `Regulatory Challenge #${currentScenario + 1}`;
            document.getElementById('riskLevel').textContent = scenario.risk + ' Risk';
            
            // Set content
            document.getElementById('storyContext').textContent = scenario.context;
            document.getElementById('researchChallenge').textContent = scenario.challenge;
            
            // Build options
            const optionsContainer = document.getElementById('decisionOptions');
            optionsContainer.innerHTML = '';
            
            scenario.options.forEach((option, index) => {
                const optionDiv = document.createElement('div');
                optionDiv.className = 'decision-option';
                optionDiv.onclick = () => makeDecision(index);
                
                const letter = String.fromCharCode(65 + index);
                optionDiv.innerHTML = `
                    <div class="option-header">
                        <div class="option-letter">${letter}</div>
                        <div>${option}</div>
                    </div>
                `;
                
                if (playerChoices[currentScenario] === index) {
                    optionDiv.classList.add('selected');
                }
                
                if (missionCompleted) {
                    if (index === scenario.correct) {
                        optionDiv.classList.add('correct');
                    } else if (playerChoices[currentScenario] === index) {
                        optionDiv.classList.add('incorrect');
                    }
                    optionDiv.onclick = null;
                }
                
                optionsContainer.appendChild(optionDiv);
            });
            
            updateMissionControls();
            
            if (missionCompleted) {
                showAnalysis();
            } else {
                hideAnalysis();
            }
        }

        function makeDecision(index) {
            if (missionCompleted) return;
            
            playerChoices[currentScenario] = index;
            const scenario = currentScenarios[currentScenario];
            
            // Apply consequences immediately
            if (scenario.consequences) {
                gameStats.budget += scenario.consequences.budget;
                gameStats.knowledge += scenario.consequences.knowledge;
                gameStats.reputation += scenario.consequences.reputation;
                gameStats.timePressure += scenario.consequences.time;
                
                // Clamp values
                gameStats.knowledge = Math.max(0, Math.min(100, gameStats.knowledge));
                gameStats.reputation = Math.max(0, Math.min(100, gameStats.reputation));
                gameStats.timePressure = Math.max(0, Math.min(100, gameStats.timePressure));
                
                updateStatsDisplay();
            }
            
            displayScenario();
        }

        function updateProgress() {
            const progress = ((currentScenario + 1) / currentScenarios.length) * 100;
            document.getElementById('progressFill').style.width = progress + '%';
            document.getElementById('missionInfo').textContent = 
                `Challenge ${currentScenario + 1} of ${currentScenarios.length}`;
        }

        function updateMissionControls() {
            const prevBtn = document.getElementById('prevMissionBtn');
            const nextBtn = document.getElementById('nextMissionBtn');
            const completeBtn = document.getElementById('completeMissionBtn');
            
            prevBtn.disabled = currentScenario === 0;
            
            if (currentScenario === currentScenarios.length - 1) {
                nextBtn.classList.add('hidden');
                completeBtn.classList.remove('hidden');
                completeBtn.disabled = playerChoices[currentScenario] === null && !missionCompleted;
            } else {
                nextBtn.classList.remove('hidden');
                completeBtn.classList.add('hidden');
                nextBtn.disabled = playerChoices[currentScenario] === null && !missionCompleted;
            }
        }

        function nextScenario() {
            if (currentScenario < currentScenarios.length - 1) {
                currentScenario++;
                displayScenario();
                updateProgress();
            }
        }

        function previousScenario() {
            if (currentScenario > 0) {
                currentScenario--;
                displayScenario();
                updateProgress();
            }
        }

        function completeMission() {
            missionCompleted = true;
            showMissionResults();
        }

        function showMissionResults() {
            document.getElementById('gameProgress').classList.add('hidden');
            document.getElementById('scenarioContainer').classList.add('hidden');
            document.getElementById('playerStats').classList.add('hidden');
            
            const resultsContainer = document.getElementById('missionResults');
            resultsContainer.classList.remove('hidden');
            
            const correctAnswers = playerChoices.reduce((count, choice, index) => {
                return count + (choice === currentScenarios[index].correct ? 1 : 0);
            }, 0);
            
            const accuracy = Math.round((correctAnswers / currentScenarios.length) * 100);
            const missionTime = Math.round((Date.now() - missionStartTime) / 1000);
            
            document.getElementById('finalScore').textContent = `${correctAnswers}/${currentScenarios.length}`;
            
            // Outcome message based on difficulty and performance
            let outcome = '';
            const difficultyMultiplier = { development_associate: 1, regulatory_scientist: 1.2, regulatory_authority: 1.5 }[selectedDifficulty];
            const finalScore = Math.round(accuracy * difficultyMultiplier);
            
            if (selectedDifficulty === 'regulatory_authority') {
                if (accuracy >= 90) outcome = '⚖️ REGULATORY AUTHORITY ACHIEVED! You now shape industry standards!';
                else if (accuracy >= 75) outcome = '🏛️ Outstanding regulatory leadership! FDA/EMA notice your expertise.';
                else if (accuracy >= 60) outcome = '📋 Solid regulatory foundation, but authority requires mastery.';
                else outcome = '📚 Regulatory authority demands deeper understanding.';
            } else if (selectedDifficulty === 'regulatory_scientist') {
                if (accuracy >= 85) outcome = '🎯 Excellent! You\'re ready for senior regulatory leadership.';
                else if (accuracy >= 70) outcome = '✅ Good regulatory performance! Continue building expertise.';
                else outcome = '📖 Review regulatory guidelines and best practices.';
            } else {
                if (accuracy >= 80) outcome = '🌟 Great start to your regulatory career at The MIDDler!';
                else if (accuracy >= 65) outcome = '🤖 Solid AI-PBPK foundation! Keep learning.';
                else outcome = '📚 Study the regulatory fundamentals and AI-PBPK basics.';
            }
            
            document.getElementById('missionOutcome').textContent = outcome;
            
            // Update achievements
            updateAchievements(accuracy, missionTime);
        }

        function updateAchievements(accuracy, missionTime) {
            const achievements = {
                accuracyAchievement: accuracy >= 80,
                speedAchievement: missionTime < (selectedLength * 60), // Under 1 min per question
                perfectionAchievement: accuracy === 100,
                riskTakerAchievement: selectedDifficulty === 'regulatory_authority' && accuracy >= 75
            };
            
            Object.entries(achievements).forEach(([id, unlocked]) => {
                const element = document.getElementById(id);
                if (unlocked) {
                    element.classList.add('unlocked');
                }
            });
        }

        function newMission() {
            // Reset all game state
            selectedDifficulty = '';
            selectedLength = 0;
            currentScenarios = [];
            currentScenario = 0;
            playerChoices = [];
            missionActive = false;
            missionCompleted = false;
            
            // Reset UI
            document.querySelectorAll('.difficulty-card').forEach(card => card.classList.remove('selected'));
            document.querySelectorAll('.length-option').forEach(option => option.classList.remove('selected'));
            document.querySelectorAll('.achievement-card').forEach(card => card.classList.remove('unlocked'));
            
            // Show setup, hide others
            document.getElementById('missionSetup').classList.remove('hidden');
            document.getElementById('playerStats').classList.add('hidden');
            document.getElementById('gameProgress').classList.add('hidden');
            document.getElementById('scenarioContainer').classList.add('hidden');
            document.getElementById('missionResults').classList.add('hidden');
            
            updateLaunchButton();
        }

        function reviewScenarios() {
            currentScenario = 0;
            
            document.getElementById('gameProgress').classList.remove('hidden');
            document.getElementById('scenarioContainer').classList.remove('hidden');
            document.getElementById('playerStats').classList.remove('hidden');
            document.getElementById('missionResults').classList.add('hidden');
            
            displayScenario();
            updateProgress();
        }

        function showAnalysis() {
            const analysis = document.getElementById('consequenceAnalysis');
            const analysisText = document.getElementById('analysisText');
            const impactSummary = document.getElementById('impactSummary');
            
            analysis.classList.remove('hidden');
            analysisText.textContent = currentScenarios[currentScenario].analysis;
            
            if (currentScenarios[currentScenario].impact) {
                impactSummary.textContent = currentScenarios[currentScenario].impact;
                impactSummary.classList.remove('hidden');
            } else {
                impactSummary.classList.add('hidden');
            }
        }

        function hideAnalysis() {
            document.getElementById('consequenceAnalysis').classList.add('hidden');
        }

        // Initialize the game
        document.addEventListener('DOMContentLoaded', () => {
            updateLaunchButton();
        });
    </script>
</body>
</html>
